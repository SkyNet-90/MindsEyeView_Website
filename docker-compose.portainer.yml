version: '3.8'

services:
  mindseyeview-app:
    image: ghcr.io/skynet-90/mindseyeview_website:latest
    container_name: mindseyeview-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://mindseyeview:${DB_PASSWORD}@mindseyeview-db:5432/mindseyeview
      - NEXTAUTH_URL=https://mindseyeview.net
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXT_PUBLIC_FACEBOOK_URL=https://www.facebook.com/profile.php?id=100066853654284
      - TZ=America/New_York
    volumes:
      - uploads_data:/app/public/uploads
    depends_on:
      mindseyeview-db:
        condition: service_healthy
      git-sync:
        condition: service_started
    networks:
      - mindseyeview-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mindseyeview-db:
    image: postgres:15-alpine
    container_name: mindseyeview-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=mindseyeview
      - POSTGRES_USER=mindseyeview
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - TZ=America/New_York
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - mindseyeview-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mindseyeview"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  git-sync:
    image: alpine/git:latest
    container_name: mindseyeview-git-sync
    restart: unless-stopped
    volumes:
      - git_repo:/repo
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - GIT_REPO=https://github.com/SkyNet-90/MindsEyeView_Website.git
      - GIT_BRANCH=main
      - SYNC_INTERVAL=300
      - GHCR_IMAGE=ghcr.io/skynet-90/mindseyeview_website:latest
      # For private repos, uncomment and set these:
      # - GITHUB_TOKEN=${GITHUB_TOKEN}
      # - GITHUB_USERNAME=SkyNet-90
    command: >
      sh -c '
        echo "üöÄ Starting git-sync for Mind'\''s Eye View deployment...";
        apk add --no-cache docker-cli curl;
        
        # Set up git credentials for private repos if token provided
        if [ -n "$GITHUB_TOKEN" ]; then
          echo "üîê Configuring git credentials for private repo...";
          git config --global credential.helper store;
          echo "https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com" > ~/.git-credentials;
          # Replace https:// URL with authenticated version
          AUTH_REPO=$(echo "$GIT_REPO" | sed "s|https://|https://$GITHUB_USERNAME:$GITHUB_TOKEN@|");
        else
          AUTH_REPO="$GIT_REPO";
        fi;
        
        # Initialize repository
        cd /repo;
        if [ ! -d ".git" ]; then
          echo "üì• Cloning repository...";
          rm -rf /repo/* /repo/.* 2>/dev/null || true;
          git clone "$AUTH_REPO" /tmp/clone || exit 1;
          cp -r /tmp/clone/* /repo/;
          cp -r /tmp/clone/.git /repo/;
          rm -rf /tmp/clone;
          cd /repo;
          git checkout "$GIT_BRANCH" || echo "Already on $GIT_BRANCH";
        fi;
        
        echo "‚úÖ Initial setup completed. Starting sync loop...";
        
        # Sync loop
        while true; do
          sleep $SYNC_INTERVAL;
          echo "üîÑ Checking for updates at $(date)";
          
          cd /repo;
          
          # Get current commit
          BEFORE=$(git rev-parse HEAD 2>/dev/null || echo "none");
          
          # Safely fetch and update
          git fetch origin || (echo "Fetch failed, continuing..." && continue);
          
          # Get the latest commit from origin
          LATEST=$(git rev-parse "origin/$GIT_BRANCH" 2>/dev/null || echo "none");
          
          if [ "$BEFORE" != "$LATEST" ] && [ "$LATEST" != "none" ]; then
            echo "üì¶ New changes detected!";
            echo "Current: $BEFORE";
            echo "Latest:  $LATEST";
            
            # Reset to latest
            git reset --hard "origin/$GIT_BRANCH" || continue;
            
            # Pull latest Docker image from GHCR
            echo "üê≥ Pulling latest Docker image...";
            docker pull "$GHCR_IMAGE" || (echo "Failed to pull image" && continue);
            
            # Restart the application container to use new image
            echo "üîÑ Restarting application...";
            docker restart mindseyeview-web || (echo "Failed to restart container" && continue);
            
            echo "‚úÖ Successfully deployed new version!";
          else
            echo "‚ÑπÔ∏è  No changes detected";
          fi;
        done
      '
    networks:
      - mindseyeview-net
    healthcheck:
      test: ["CMD", "test", "-d", "/repo/.git"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  cloudflared-mindseyeview:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-mindseyeview
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CF_TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    depends_on:
      - mindseyeview-app
    networks:
      - mindseyeview-net
    healthcheck:
      test: ["CMD", "pgrep", "cloudflared"]
      interval: 30s
      timeout: 10s
      retries: 3

  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: mindseyeview-filebrowser
    restart: unless-stopped
    ports:
      - "8083:80"
    volumes:
      - uploads_data:/srv/uploads:ro
      - git_repo:/srv/git:ro
      - filebrowser_db:/database
    environment:
      - FB_BASEURL=/
      - FB_NOAUTH=false
    networks:
      - mindseyeview-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  uploads_data:
    driver: local
  git_repo:
    driver: local
  filebrowser_db:
    driver: local

networks:
  mindseyeview-net:
    driver: bridge
